name: aiDroid S25 - Build & Test

on:
  push:
    branches: [ main, s25-optimierung ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint-and-test:
    name: ğŸ” Code Quality & Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff black pytest kivy kivymd requests
        
    - name: ğŸ” Run Ruff Linting
      run: ruff check . --output-format=github
      
    - name: ğŸ¨ Check Black Formatting
      run: black --check --diff .
      
    - name: ğŸ§ª Run Tests
      run: pytest tests/ -v || echo "âš ï¸ Tests noch nicht implementiert"

  build-apk:
    name: ğŸ”¨ Build Android APK
    needs: lint-and-test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ¤– Build APK with Buildozer
      uses: ArtemSBulgakov/buildozer-action@v1
      with:
        command: buildozer android debug
        buildozer_version: stable
        
    - name: ğŸ“Š APK Analysis
      run: |
        ls -la bin/
        if [ -f bin/*.apk ]; then
          APK_SIZE=$(stat -c%s bin/*.apk)
          echo "ğŸ“± APK Size: $(($APK_SIZE / 1024 / 1024)) MB"
          echo "APK_SIZE_MB=$(($APK_SIZE / 1024 / 1024))" >> $GITHUB_ENV
        fi
        
    - name: ğŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aiDroid-S25-v${{ github.run_number }}
        path: bin/*.apk
        retention-days: 30
        
    - name: ğŸ’¬ Comment APK Info
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸ¤– **aiDroid S25 Build Complete!**
            
            ğŸ“± APK Size: ${{ env.APK_SIZE_MB }} MB
            ğŸ”§ Build #${{ github.run_number }}
            âœ… Samsung Galaxy S25 optimiert
            ğŸš€ Ready for deployment!`
          })

  release:
    name: ğŸš€ Create Release
    needs: build-apk
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Download APK
      uses: actions/download-artifact@v4
      with:
        name: aiDroid-S25-v${{ github.run_number }}
        
    - name: ğŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2.0.${{ github.run_number }}
        name: aiDroid S25 Pro v2.0.${{ github.run_number }}
        body: |
          ğŸ¤– **aiDroid fÃ¼r Samsung Galaxy S25**
          
          âœ¨ **Features:**
          - ğŸ”¥ Samsung Galaxy S25 Optimierung
          - âš¡ Android 15 / One UI 7 Support  
          - ğŸ§  Context Memory System
          - ğŸ”„ Async Processing
          - ğŸ’¾ Smart Caching
          - ğŸ›¡ï¸ Enhanced Security
          
          ğŸ“± **KompatibilitÃ¤t:**
          - Samsung Galaxy S25 Series
          - Android 15+ (API 35)
          - One UI 7.x
          
          ğŸ”§ **Technische Details:**
          - Python 3.11.5
          - Kivy 2.3.1 + KivyMD 2.0.1
          - Optimiert fÃ¼r Snapdragon 8 Elite
          - ProGuard Code Shrinking
          
        files: "*.apk"
        prerelease: false
