name: aiDroid S25 - Build & Test

on:
  push:
    branches: [ main, s25-optimierung ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint-and-test:
    name: 🔍 Code Quality & Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: 🐍 Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff black pytest kivy kivymd requests
        
    - name: 🔍 Run Ruff Linting
      run: ruff check . --output-format=github
      
    - name: 🎨 Check Black Formatting
      run: black --check --diff .
      
    - name: 🧪 Run Tests
      run: pytest tests/ -v || echo "⚠️ Tests noch nicht implementiert"

  build-apk:
    name: 🔨 Build Android APK
    needs: lint-and-test
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      
    - name: 🤖 Build APK with Buildozer
      uses: ArtemSBulgakov/buildozer-action@v1
      with:
        command: buildozer android debug
        buildozer_version: stable
        
    - name: 📊 APK Analysis
      run: |
        ls -la bin/
        if [ -f bin/*.apk ]; then
          APK_SIZE=$(stat -c%s bin/*.apk)
          echo "📱 APK Size: $(($APK_SIZE / 1024 / 1024)) MB"
          echo "APK_SIZE_MB=$(($APK_SIZE / 1024 / 1024))" >> $GITHUB_ENV
        fi
        
    - name: 📤 Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aiDroid-S25-v${{ github.run_number }}
        path: bin/*.apk
        retention-days: 30
        
    - name: 💬 Comment APK Info
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `🤖 **aiDroid S25 Build Complete!**
            
            📱 APK Size: ${{ env.APK_SIZE_MB }} MB
            🔧 Build #${{ github.run_number }}
            ✅ Samsung Galaxy S25 optimiert
            🚀 Ready for deployment!`
          })

  release:
    name: 🚀 Create Release
    needs: build-apk
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: 📥 Download APK
      uses: actions/download-artifact@v4
      with:
        name: aiDroid-S25-v${{ github.run_number }}
        
    - name: 🏷️ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2.0.${{ github.run_number }}
        name: aiDroid S25 Pro v2.0.${{ github.run_number }}
        body: |
          🤖 **aiDroid für Samsung Galaxy S25**
          
          ✨ **Features:**
          - 🔥 Samsung Galaxy S25 Optimierung
          - ⚡ Android 15 / One UI 7 Support  
          - 🧠 Context Memory System
          - 🔄 Async Processing
          - 💾 Smart Caching
          - 🛡️ Enhanced Security
          
          📱 **Kompatibilität:**
          - Samsung Galaxy S25 Series
          - Android 15+ (API 35)
          - One UI 7.x
          
          🔧 **Technische Details:**
          - Python 3.11.5
          - Kivy 2.3.1 + KivyMD 2.0.1
          - Optimiert für Snapdragon 8 Elite
          - ProGuard Code Shrinking
          
        files: "*.apk"
        prerelease: false
